<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title> TGOM </title>

	<style>
		
		/*** TODO: Put CSS code in separate file. ***/
		
		/* Code for only showing the page with the class "current-page". */
		main > .page{
			display: none;
		}
		
		main > .page.current-page{
			display: block;
		}
		
		/* Code for hiding elements depending on if the user is logged in or not. */
		.is-logged-in .if-is-logged-out{
			display: none;
		}
		
		.is-logged-out .if-is-logged-in{
			display: none;
		}
		
	</style>

	

	<script>

    	const BACKEND_URI = "http://localhost:8000/api/"
		
		// TODO: Want to remember the access token across page reloads?
		// You could for example store it in local storage, although that
		// would be really bad if your website contains a XSS vulnerability.
		let accessToken = ""
		const USERNAME_MIN_LENGTH = 3
		const USERNAME_MAX_LENGTH = 20
		const PASSWORD_MAX_LENGTH = 25
		
		document.addEventListener("DOMContentLoaded", function(){
			
			showPage(location.pathname)
			
			// TODO: Write comment explaining why we listen for click on links
			// this very strange way.
			document.body.addEventListener("click", function(event){
				
				const clickedElement = event.target
				
				if(clickedElement.tagName == "A"){
					
					if(clickedElement.hostname == location.hostname){
						
						event.preventDefault()
						
						const uri = clickedElement.getAttribute("href")
						
						if(location.pathname != uri){
							
							hideCurrentPage()
							showPage(uri)
							
							history.pushState({}, "", uri)
							
						}
						
					}
					
				}
				
			})


			document.getElementById("login-form").addEventListener("submit", async function(event){
				
				event.preventDefault()
				const page = document.getElementById("login-page")
				
				const username = document.getElementById("username").value
				const password = document.getElementById("password").value

				const data = {
					username,
					password,
					//grant_type: "password"
				}
				console.log("ðŸš€ ~ file: index.html ~ line 90 ~ document.getElementById ~ data", data)

				validateAccount = function(data){
					const errors =[]

					
					if(data.username.length < USERNAME_MIN_LENGTH){
						errors.push("usernameTooShort")
					}

					if(data.username.length > USERNAME_MAX_LENGTH){
						errors.push("usernameTooLong")
					}
					if(data.password.length > PASSWORD_MAX_LENGTH){
						errors.push("passwordTooLong")
					}

					if(data.password.length == 0){
						errors.push("passwordTooLong")
					}

					return errors
				}

				const errors = validateAccount(data)

				if(errors.length > 0){
					
					const ul = document.createElement("ul")
					page.appendChild(ul)
					for(const error of errors){
						const li = document.createElement("li")
						li.innerText = error
						ul.appendChild(li)
					}
					
				}
				else{
				
					const response = await fetch(BACKEND_URI+"account/sign-in", {
						method: "POST",
						headers: {
							"Content-Type": "application/x-www-form-urlencoded"
						},
						body: new URLSearchParams(data)
					})
					
					switch(response.status){
						
						case 200:
							
							var body = await response.json()
							
							accessToken = body.access_token
                            console.log("ðŸš€ ~ file: index.html ~ line 148 ~ document.getElementById ~ accessToken", accessToken)
							
							document.body.classList.remove("is-logged-out")
							document.body.classList.add("is-logged-in")
							
							// TODO: Show feedback to the user (did the login succeed?).
							
							break
						case 400:

							body = await response.json()
							const errors = body.errorMessages
                            console.log("ðŸš€ ~ file: index.html ~ line 155 ~ document.getElementById ~ errors", errors)
							
							if(errors.length > 0){
								const errorClass = document.getElementById("errors")
								const ul = document.createElement("ul")
								errorClass.appendChild(ul)
								for(error in errors){
									const li = document.createElement("li")
									li.innerText(error)
									ul.appendChild(li)
								}
								
							}		
							break
						case 500:
							body = await response.json()

							errors = body.internalError
								
							if(errors.length > 0){ 
								const errorClass = document.getElementById("errors")
								const ul = document.createElement("ul")
								errorClass.appendChild(ul)
								for(error in errors){
									const li = document.createElement("li")
									li.innerText(error)
									ul.appendChild(li)
								}
							}	
						default:
							
							// TODO.
						
					}
				}

			})

			document.getElementById("create-feedback-form").addEventListener("submit", async function(event){
				
				event.preventDefault()
				
				const title = document.getElementById("title").value
				const game = document.getElementById("game").value
				const content = document.getElementById("content").value
				
				// TODO: Can add client-side validation here.
				
				const feedback = {
					title,
					game,
					content
				}
				
				// TODO: Here we can start showing a loading indicator.
				const response = await fetch(BACKEND_URI+"sign-out", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						"Authorization": "Bearer "+accessToken
					},
					body: JSON.stringify(feedback)
				})
				// TODO: And here we can stop showing a loading indicator.
				
				switch(response.status){
					
					case 201:
						
						const createdFeedback = await response.json()
						
						const uri = "/humans/"+createdFeedback.id
						
						// TODO: This is the same code that runs when clicking on a link. Function instead of code duplication?
						history.pushState({}, "", uri)
						hideCurrentPage()
						showPage(uri)
						
					break
					case 400:
					var body = await response.json()

					var errors = body.errorMessages
						
					if(errors.length > 0){
						const errorClass = document.getElementById("errors")
						const ul = document.createElement("ul")
						errorClass.appendChild(ul)
						for(error in errors){
							const li = document.createElement("li")
							li.innerText(error)
							ul.appendChild(li)
						}
						
					}	

					break
					case 500:

					 	body = await response.json()

						errors = body.internalError
							
						if(errors.length > 0){
							const errorClass = document.getElementById("errors")
							const ul = document.createElement("ul")
							errorClass.appendChild(ul)
							for(error in errors){
								const li = document.createElement("li")
								li.innerText(error)
								ul.appendChild(li)
							}
							
						}	
					default:
						// TODDO.
				}
				
			})
		
			
			window.addEventListener("popstate", function(event){
				event.preventDefault()
				const uri = location.pathname
				hideCurrentPage()
				showPage(uri)
			
			})

			function showPage(uri){
			
			let newPageId = ""
			
				switch(uri){
					
					case "/":
						newPageId = "home-page"
					break
					case "/about":
						newPageId = "about-page"
					break
					case "/login":
						newPageId = "login-page"
					break
					case "/create-feedback":
						newPageId = "create-feedback-page"
					break
					case "/feedbacks":
						newPageId = "all-feedbacks-page"
						loadAllFeedbacks()
					break
					case "/register":
						newPageId = "regester-page"
						//loadAllFeedbacks()
					break
					default:
						
						if(uri.startsWith("/feedbacks/")){
							newPageId = "feedback-page"
							const feedbackId = uri.split("/")[2]
							loadFeedbackPage(feedbackId)
						}else{
							newPageId = "not-found-page"
						}
					
				}
				document.getElementById(newPageId).classList.add("current-page")
				
			}

			function hideCurrentPage(){
				document.querySelector(".current-page").classList.remove("current-page")
			}


			async function loadAllFeedbacks(){
				
				const page = document.getElementById("all-feedbacks-page")
				page.innerText = ""
				
				const h1 = document.createElement("h1")
				h1.innerText = "All Feedbacks"
				page.appendChild(h1)
				
				const response = await fetch(BACKEND_URI+"feedbacks")
				const ul = document.createElement("ul")

				switch(response.status){
					
					case 200:
						
						const feedbacks = await response.json()
		
						
						for(const feedback of feedbacks){
							const li = document.createElement("li")
							const a = document.createElement("a")
							a.innerText = feedback.title
							a.setAttribute("href", "/feedbacks/"+feedback.id)
							li.appendChild(a)
							ul.appendChild(li)
						}
						page.appendChild(ul)
						
					break
					
					case 500:

						const errors = await response.json()
						
						
						for(const error of errors){
							const li = document.createElement("li")
							li.innerText = error
							ul.appendChild(li)
						}
						page.appendChild(ul)

					break
					default:
						const h1 = document.createElement("h1")
						h1.innerText = "no page found" 
						page.appendChild(h1)
						 
					
					
				}
				
			}
			
			async function loadFeedbackPage(id){
				const page = document.getElementById("feedback-page")
				page.innerText = ""
				
				const h1 = document.createElement("h1")
				h1.innerText = "Feedback"
				page.appendChild(h1)
				
				const response = await fetch(BACKEND_URI+"feedbacks/"+id)
				
				switch(response.status){
					
					case 200:
						
						const feedback = await response.json()

						
						const titleP = document.createElement("p")
						const usernameP = document.createElement("p")
						const gameP = document.createElement("p")
						const contentP = document.createElement("p")
						
						titleP.innerText ="Title: "+ feedback.title
						usernameP.innerText ="By: "+ feedback.username
						gameP.innerText ="Game: "+ feedback.game
						contentP.innerText ="Content: "+ feedback.content
						
						page.appendChild(usernameP)
						page.appendChild(titleP)
						page.appendChild(gameP)
						page.appendChild(contentP)
						
					break
					
					case 500:

						const errors = await response.json()
						
						const ul = document.createElement("ul")
						
						for(const error of errors){
							const li = document.createElement("li")
							li.innerText = error
							ul.appendChild(li)
						}
						page.appendChild(ul)

					break

					default:
						const h1 = document.createElement("h1")
						h1.innerText = "no page found" 
						page.appendChild(h1)
				}
			}
		
			async function regesterAccount(account) {
				
			}
		})	
	</script>

</head>
	<body class="is-logged-out">

		
		<header>
			My Site
		</header>
		
		<nav>
			<ul>
				<li><a href="/">Home</a></li>
				<li><a href="/feedbacks">feedbacks</a></li>
				<li class="if-is-logged-in"><a href="/create-feedback">Create feedback</a></li>
				<li class="if-is-logged-out"><a href="/login">Login</a></li>
				<li class="if-is-logged-out"><a href="/register">Register</a></li>
			</ul>
		</nav>
		
		<main>
			
			<div class="page" id="home-page">
				<h1>Home</h1>
				<p>Welcome to this site!</p>
				<p>Go to <a href="/about">About page</a>.</p>
			</div>
			
			
			<div class="page" id="register-page">
				<h1>Create</h1>
				<form action=""  name="register">
					<div class="form-group has-success">
						<label class="form-label" for="input-example-1">Name:</label>
						<input class="form-input" type="text"  name="name" placeholder="Name" required>
					</div>
					<div class="form-group has-success">
						<label class="form-label" for="input-example-1">Username:</label>
						<input class="form-input" type="text" name="username" placeholder="Username" required>
					</div>
					<div class="form-group">
						<label class="form-label" for="input-example-1">Password:</label>
						<input class="form-input" type="password"  name="password" placeholder="Password" required>
					</div>      
					<div class="form-group">
						<label class="form-label" for="input-example-1">Repeat Password:</label>
						<input class="form-input" type="password"  name="repeat_password" placeholder="Repeat Password" required>
					</div> 
						<button class="btn" type="submit" value="register">Register</button>
				</form>
			</div>
			
			<div class="page" id="login-page">
				<h1>Login</h1>
				<form action="" id="login-form">
					<div>
						Username: <input type="text" id="username">
					</div>
					<div>
						Password: <input type="password" id="password">
					</div>
					<input type="submit" value="Login">
				</form>
			</div>

			<div class="page" id="create-feedback-page">
				<form action="" id="create-feedback-form">
					<div>
						Title: <input type="name" name="title" >
					</div>
					<div>
						Game: <input type="name" name="game" >
					</div>
					<div id="update_textarea">
						content: <textarea class="update_textarea" type="text" name="content" rows="4" cols="60" > </textarea>
					</div>
					<div id="submit_update">
						<input class="submit_update_btn" type="submit" name="create-btn" value="CREATE">
					</div>	
				</form>
			</div>	
			
			
			<div class="page" id="all-feedbacks-page"> </div>
			
			<div class="page" id="feedback-page"></div>
			
			<div class="page" id="not-found-page">
				<h1>Not Found</h1>
			</div>
			
		</main>
		
		
	</body>
</html>